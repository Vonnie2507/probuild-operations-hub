// ============================================
// PROBUILD OPERATIONS HUB
// Database Schema (Prisma)
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USERS & AUTH
// ============================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  role      UserRole @default(STAFF)
  password  String   // Hashed
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  documents          LiveDocument[]      @relation("CreatedBy")
  documentChanges    DocumentChange[]
  prestartMeetings   PrestartMeeting[]
  uploadedFiles      DocumentFile[]

  @@map("users")
}

enum UserRole {
  ADMIN
  SALES
  SCHEDULER
  PRODUCTION
  INSTALLATION
  STAFF
}

// ============================================
// LIVE PROJECT DOCUMENTS
// ============================================

model LiveDocument {
  id        String         @id @default(uuid())
  status    DocumentStatus @default(LEAD)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  // Link to Jobman (nullable - can exist without Jobman link)
  jobmanLeadId  String? @map("jobman_lead_id")
  jobmanQuoteId String? @map("jobman_quote_id")
  jobmanJobId   String? @map("jobman_job_id")

  // Customer Info (can be pulled from Jobman or entered manually)
  customerName    String  @map("customer_name")
  customerEmail   String? @map("customer_email")
  customerPhone   String? @map("customer_phone")
  customerMobile  String? @map("customer_mobile")

  // Site Address
  siteAddress       String? @map("site_address")
  siteAddressLine1  String? @map("site_address_line1")
  siteAddressLine2  String? @map("site_address_line2")
  siteCity          String? @map("site_city")
  siteState         String? @map("site_state")
  sitePostcode      String? @map("site_postcode")

  // ============================================
  // EXTENDED FIELDS (not in Jobman)
  // ============================================

  // Site Access Details
  siteAccess        String? @map("site_access") @db.Text
  parkingDetails    String? @map("parking_details") @db.Text
  gateCode          String? @map("gate_code")
  keyLocation       String? @map("key_location")

  // Ground & Site Conditions
  groundConditions  String? @map("ground_conditions") @db.Text // Rocky, sandy, clay, etc.
  slopeDetails      String? @map("slope_details") @db.Text
  undergroundServices String? @map("underground_services") @db.Text // Power, water, gas, etc.
  dbydReference     String? @map("dbyd_reference") // Dial Before You Dig reference

  // Existing Fence
  existingFence     String? @map("existing_fence") @db.Text
  removalRequired   Boolean @default(false) @map("removal_required")
  removalNotes      String? @map("removal_notes") @db.Text

  // Utilities
  powerAvailable    Boolean @default(false) @map("power_available")
  waterAvailable    Boolean @default(false) @map("water_available")
  toiletAvailable   Boolean @default(false) @map("toilet_available")

  // Special Requirements
  dogOnProperty     Boolean @default(false) @map("dog_on_property")
  dogDetails        String? @map("dog_details")
  neighbourContact  String? @map("neighbour_contact") @db.Text
  councilApproval   Boolean @default(false) @map("council_approval")
  councilReference  String? @map("council_reference")
  specialRequirements String? @map("special_requirements") @db.Text

  // Scheduling Preferences
  preferredDays     String[] @map("preferred_days") // Array of days
  preferredTimes    String? @map("preferred_times")
  accessRestrictions String? @map("access_restrictions") @db.Text

  // Installation Notes
  installNotes      String? @map("install_notes") @db.Text
  productionNotes   String? @map("production_notes") @db.Text

  // Custom Fields (JSON for anything else)
  customFields      Json?   @map("custom_fields") @default("{}")

  // Template-based forms
  templateId        String? @map("template_id")
  templateName      String? @map("template_name")
  formData          Json?   @map("form_data") @default("{}")

  // Created By
  createdById       String  @map("created_by_id")
  createdBy         User    @relation("CreatedBy", fields: [createdById], references: [id])

  // Relations
  files             DocumentFile[]
  changes           DocumentChange[]
  communications    Communication[]
  prestartJobs      PrestartMeetingJob[]

  @@index([jobmanLeadId])
  @@index([jobmanQuoteId])
  @@index([jobmanJobId])
  @@index([status])
  @@index([customerName])
  @@map("live_documents")
}

enum DocumentStatus {
  LEAD          // Sales gathering info
  QUOTED        // Quote sent, waiting response
  ACCEPTED      // Quote accepted, scheduling
  SCHEDULED     // Installation scheduled
  IN_PROGRESS   // Currently installing
  COMPLETED     // Job complete
  CANCELLED     // Cancelled
  ON_HOLD       // On hold
}

// ============================================
// DOCUMENT FILES
// ============================================

model DocumentFile {
  id          String   @id @default(uuid())
  documentId  String   @map("document_id")
  document    LiveDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  fileName    String   @map("file_name")
  fileType    FileType @map("file_type")
  fileUrl     String   @map("file_url")
  thumbnailUrl String? @map("thumbnail_url")
  fileSize    Int?     @map("file_size") // bytes
  mimeType    String?  @map("mime_type")

  // Categorisation
  section     FileSection @default(GENERAL)
  description String?  @db.Text

  // Metadata
  uploadedById String  @map("uploaded_by_id")
  uploadedBy   User    @relation(fields: [uploadedById], references: [id])
  uploadedAt   DateTime @default(now()) @map("uploaded_at")

  // If synced to Jobman
  jobmanFileId String? @map("jobman_file_id")

  @@index([documentId])
  @@index([section])
  @@map("document_files")
}

enum FileType {
  IMAGE
  VIDEO
  PDF
  DOCUMENT
  OTHER
}

enum FileSection {
  GENERAL
  SITE_PHOTOS
  MEASUREMENTS
  PROGRESS
  COMPLETION
  SIGNOFF
  COMMUNICATIONS
}

// ============================================
// CHANGE TRACKING (AUDIT TRAIL)
// ============================================

model DocumentChange {
  id          String   @id @default(uuid())
  documentId  String   @map("document_id")
  document    LiveDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  fieldName   String   @map("field_name")
  oldValue    String?  @map("old_value") @db.Text
  newValue    String?  @map("new_value") @db.Text

  changedById String   @map("changed_by_id")
  changedBy   User     @relation(fields: [changedById], references: [id])
  changedAt   DateTime @default(now()) @map("changed_at")

  // Approval workflow
  approvalRequired Boolean @default(false) @map("approval_required")
  approvedById     String? @map("approved_by_id")
  approvedAt       DateTime? @map("approved_at")

  @@index([documentId])
  @@index([fieldName])
  @@index([changedAt])
  @@map("document_changes")
}

// ============================================
// COMMUNICATIONS (attached to documents)
// ============================================

model Communication {
  id          String   @id @default(uuid())
  documentId  String   @map("document_id")
  document    LiveDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  type        CommunicationType
  direction   CommunicationDirection @default(INBOUND)
  subject     String?
  content     String   @db.Text
  sender      String?  // Email/phone of sender
  recipient   String?  // Email/phone of recipient
  receivedAt  DateTime @map("received_at")
  createdAt   DateTime @default(now()) @map("created_at")

  // AI-extracted info
  aiExtractedData Json? @map("ai_extracted_data")

  @@index([documentId])
  @@index([type])
  @@map("communications")
}

enum CommunicationType {
  EMAIL
  SMS
  PHONE_CALL
  MEETING_NOTE
  OTHER
}

enum CommunicationDirection {
  INBOUND
  OUTBOUND
}

// ============================================
// PRE-START MEETINGS
// ============================================

model PrestartMeeting {
  id          String   @id @default(uuid())
  meetingDate DateTime @map("meeting_date")
  createdAt   DateTime @default(now()) @map("created_at")

  // Who ran the meeting
  runById     String   @map("run_by_id")
  runBy       User     @relation(fields: [runById], references: [id])

  // Staff present (array of names or user IDs)
  staffPresent String[] @map("staff_present")

  // Recording & Transcript
  recordingUrl String? @map("recording_url")
  transcript   String? @db.Text
  transcriptStatus TranscriptStatus @default(NONE) @map("transcript_status")

  // AI-generated summary
  aiSummary    Json?   @map("ai_summary")
  // Structure: {
  //   challenges: [{ description, resolution }],
  //   wins: [{ description }],
  //   safetyTopics: [{ topic, notes }],
  //   actionItems: [{ item, assignee }]
  // }

  // Manual notes (if any)
  manualNotes  String? @map("manual_notes") @db.Text

  // Template form data (JSON for custom template fields)
  formData     Json?   @map("form_data") @default("{}")

  // Jobs discussed
  jobs         PrestartMeetingJob[]

  @@index([meetingDate])
  @@map("prestart_meetings")
}

enum TranscriptStatus {
  NONE
  PROCESSING
  COMPLETED
  FAILED
}

// Link between pre-start meetings and live documents
model PrestartMeetingJob {
  id            String   @id @default(uuid())
  prestartId    String   @map("prestart_id")
  prestart      PrestartMeeting @relation(fields: [prestartId], references: [id], onDelete: Cascade)
  documentId    String   @map("document_id")
  document      LiveDocument @relation(fields: [documentId], references: [id])

  // Installer assigned to this job that day
  installerName String   @map("installer_name")

  // Which day of the job (yesterday or today)
  dayType       DayType  @map("day_type")

  // Compliance data (from Jobman or manual)
  clockedIn     Boolean  @default(false) @map("clocked_in")
  clockedOut    Boolean  @default(false) @map("clocked_out")
  checkedIn     Boolean  @default(false) @map("checked_in")
  checkedOut    Boolean  @default(false) @map("checked_out")
  photosUploaded Boolean @default(false) @map("photos_uploaded")
  tasksCompleted Boolean @default(false) @map("tasks_completed")

  // Notes for this job in this meeting
  notes         String?  @db.Text

  @@unique([prestartId, documentId, dayType])
  @@map("prestart_meeting_jobs")
}

enum DayType {
  YESTERDAY
  TODAY
}

// ============================================
// FORM TEMPLATES
// ============================================

model FormTemplate {
  id          String   @id @default(uuid())
  name        String
  description String?  @db.Text
  type        FormType @default(CUSTOM)

  // The HTML template with {{ variable }} placeholders
  htmlTemplate String  @map("html_template") @db.Text

  // CSS styles (optional)
  cssStyles    String? @map("css_styles") @db.Text

  // Active/inactive
  isActive    Boolean  @default(true) @map("is_active")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Form submissions using this template
  submissions FormSubmission[]

  @@index([type])
  @@index([isActive])
  @@map("form_templates")
}

enum FormType {
  SITE_ASSESSMENT
  RISK_ASSESSMENT
  PRESTART_CHECKLIST
  PRESTART_MEETING
  COMPLETION_FORM
  SIGNOFF_FORM
  CUSTOM
}

// Filled-out form submissions
model FormSubmission {
  id          String   @id @default(uuid())
  templateId  String   @map("template_id")
  template    FormTemplate @relation(fields: [templateId], references: [id])

  // Link to document/job (optional)
  documentId  String?  @map("document_id")

  // The rendered HTML with data filled in
  renderedHtml String  @map("rendered_html") @db.Text

  // Form responses as JSON
  responses   Json     @default("{}")

  // Metadata
  submittedBy String?  @map("submitted_by")
  submittedAt DateTime @default(now()) @map("submitted_at")

  // Signature (if required)
  signatureUrl String? @map("signature_url")

  @@index([templateId])
  @@index([documentId])
  @@map("form_submissions")
}

// ============================================
// JOBMAN SYNC LOG
// ============================================

model JobmanSyncLog {
  id          String   @id @default(uuid())
  entityType  String   @map("entity_type") // lead, quote, job, contact
  entityId    String   @map("entity_id")   // Jobman UUID
  action      String   // created, updated, synced
  direction   String   // inbound (from Jobman), outbound (to Jobman)
  payload     Json?    // Data that was synced
  status      String   // success, failed
  errorMessage String? @map("error_message")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("jobman_sync_log")
}

// ============================================
// FIELD MAPPING (Future Jobman API Integration)
// ============================================

model FieldMapping {
  id              String   @id @default(uuid())
  tableName       String   @map("table_name")      // e.g., "Staff", "PreStartMeeting"
  ourFieldName    String   @map("our_field_name")  // e.g., "name", "jobDescription"
  jobmanFieldName String?  @map("jobman_field_name") // Fill in later when API fields known
  jobmanEndpoint  String?  @map("jobman_endpoint")   // e.g., "/staff", "/jobs"
  syncEnabled     Boolean  @default(false) @map("sync_enabled")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@unique([tableName, ourFieldName])
  @@index([tableName])
  @@map("field_mappings")
}

// ============================================
// STAFF (Operations Team)
// ============================================

model Staff {
  id              String    @id @default(uuid())
  jobmanId        String?   @map("jobman_id")       // For future Jobman sync
  jobmanSyncedAt  DateTime? @map("jobman_synced_at")
  name            String
  role            StaffRole
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  meetingsRun       PreStartMeeting[]       @relation("MeetingRunBy")
  meetingAttendance MeetingAttendee[]
  yesterdayReviews  YesterdayJobReview[]
  complianceChecks  ComplianceCheck[]

  @@index([role])
  @@index([isActive])
  @@map("staff")
}

enum StaffRole {
  field_installer
  workshop
  operations
  admin
}

// ============================================
// PRE-START MEETING (New Structured System)
// ============================================

model PreStartMeeting {
  id              String    @id @default(uuid())
  jobmanId        String?   @map("jobman_id")
  jobmanSyncedAt  DateTime? @map("jobman_synced_at")
  meetingDate     DateTime  @unique @map("meeting_date") @db.Date
  startTime       DateTime  @map("start_time")
  endTime         DateTime? @map("end_time")
  durationMinutes Int?      @map("duration_minutes")
  runById         String    @map("run_by_id")
  runBy           Staff     @relation("MeetingRunBy", fields: [runById], references: [id])
  status          MeetingStatus @default(draft)
  editLog         Json      @default("[]") @map("edit_log") // Array of edit events
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  attendees         MeetingAttendee[]
  yesterdayReviews  YesterdayJobReview[]
  complianceChecks  ComplianceCheck[]
  content           MeetingContent[]
  closeChecks       MeetingCloseCheck?

  @@index([meetingDate])
  @@index([status])
  @@map("pre_start_meetings")
}

enum MeetingStatus {
  draft
  completed
}

// Meeting Attendees (Many-to-Many)
model MeetingAttendee {
  id        String          @id @default(uuid())
  meetingId String          @map("meeting_id")
  meeting   PreStartMeeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  staffId   String          @map("staff_id")
  staff     Staff           @relation(fields: [staffId], references: [id])
  createdAt DateTime        @default(now()) @map("created_at")

  @@unique([meetingId, staffId])
  @@map("meeting_attendees")
}

// ============================================
// YESTERDAY'S JOB REVIEW
// ============================================

model YesterdayJobReview {
  id             String          @id @default(uuid())
  meetingId      String          @map("meeting_id")
  meeting        PreStartMeeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  staffId        String          @map("staff_id")
  staff          Staff           @relation(fields: [staffId], references: [id])
  jobmanJobId    String?         @map("jobman_job_id") // Link to Jobman job later
  jobDescription String          @map("job_description") @db.Text
  stageLeftAt    String?         @map("stage_left_at")
  notes          String?         @db.Text
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")

  @@index([meetingId])
  @@index([staffId])
  @@map("yesterday_job_reviews")
}

// ============================================
// COMPLIANCE CHECK
// ============================================

model ComplianceCheck {
  id        String          @id @default(uuid())
  meetingId String          @map("meeting_id")
  meeting   PreStartMeeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  staffId   String          @map("staff_id")
  staff     Staff           @relation(fields: [staffId], references: [id])
  checkType String          @map("check_type") // References ComplianceCheckConfig.checkKey
  completed Boolean         @default(false)
  createdAt DateTime        @default(now()) @map("created_at")
  updatedAt DateTime        @updatedAt @map("updated_at")

  @@unique([meetingId, staffId, checkType])
  @@index([meetingId])
  @@map("compliance_checks")
}

// Compliance Check Configuration (Editable without code changes)
model ComplianceCheckConfig {
  id              String   @id @default(uuid())
  checkKey        String   @unique @map("check_key") // e.g., "clocked_in_out"
  checkLabel      String   @map("check_label")       // e.g., "Clocked in/out"
  applicableRoles String[] @map("applicable_roles")  // ["field_installer", "workshop"]
  sortOrder       Int      @map("sort_order")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([isActive])
  @@map("compliance_check_configs")
}

// ============================================
// MEETING CONTENT (Sections)
// ============================================

model MeetingContent {
  id          String          @id @default(uuid())
  meetingId   String          @map("meeting_id")
  meeting     PreStartMeeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  sectionType ContentSection  @map("section_type")
  content     String          @db.Text
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  @@unique([meetingId, sectionType])
  @@map("meeting_content")
}

enum ContentSection {
  challenge
  resolution
  win
  safetyTalk
  todaysJobs
}

// ============================================
// MEETING CLOSE CHECKS
// ============================================

model MeetingCloseCheck {
  id                  String          @id @default(uuid())
  meetingId           String          @unique @map("meeting_id")
  meeting             PreStartMeeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  understandJobs      Boolean         @default(false) @map("understand_jobs")
  haveToolsMaterials  Boolean         @default(false) @map("have_tools_materials")
  questionsAddressed  Boolean         @default(false) @map("questions_addressed")
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")

  @@map("meeting_close_checks")
}
